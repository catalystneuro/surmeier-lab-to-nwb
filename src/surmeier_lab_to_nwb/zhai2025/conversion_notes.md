# Zhai 2025 Conversion Notes

## Paper
Here is the paper:
https://www.biorxiv.org/content/10.1101/2025.01.02.631090v1.full

## Scope of Work (Private Access)
https://docs.google.com/document/d/1ITmVEEOQ1TbBC8hvZvkdQ-VcdW9_ynUWFwfRxBBrAGQ/edit?usp=sharing


### Some glossary for better reading the paper
* **levodopa** the treatment for Parkinson's disease
* **levodopa-induced dyskinesia (LID)** a set of erratic movements induced by levodopa after long-term treatment
* **rheobase** the minimal electric current required to excite a tissue (as nerve or muscle) given an indefinitely long time during which the current is applied,
* **SPNs** spiny projection neurons
* **dSPNs** direct pathway SPNs
* **iSPNs** indirect pathway SPNs
* **M1Rs** Muscarinic acetylcholine receptors. M1 receptor activation occurs when acetylcholine (the natural neurotransmitter) or other muscarinic agonists (such as muscarine, which is where these receptors get their name).
* **SCH** SCH23390, a pharmacological compound that acts as a selective antagonist at the dopamine D₁ receptor (D1R). In other words, SCH23390 blocks D1-type dopaminergic signaling in neurons.
* **2PLSM** Two Photon Laser Scanning Microscopy
* **SUL** sulpiride, a selective D2 dopamine receptor antagonist. By blocking D2-type receptors, sulpiride is used to test whether observed changes (in this case, decreased iSPN excitability in the on-state) depend on ongoing D2R signaling.

Corroborate this:

The STK metadata in this context likely refers to metadata extracted from a MetaMorph STK file, a format used in microscopy for storing image sequences. STK files are essentially TIFF files with additional MetaMorph-specific metadata embedded in the tags. This metadata typically contains acquisition parameters, calibration details, and channel information.

These are taggs appearong in the dendritic experiments of the Figures 1 and 3.

What is this Device:
 MultiClamp 700B




# Scope of Work (the conversion part)

## Conversion of Data Streams

Build interfaces to convert the following data streams to NWB format:

- Convert ABF format:
- Convert Bruker optical sensor recordings with appropriate metadata
- Convert electrophysiological data acquired with the Bruker system
- Build an interface for manual segmentation data in Surmeier lab format
- Integrate behavioral annotations from Surmeier lab custom format
- Include behavioral video recordings
- Include electrical stimulation signals and metadata

Each conversion will utilize compression for efficient storage and implement chunking strategies to optimize for cloud storage. Detailed documentation will be provided for the installation and usage of the conversion software, including scripts to handle data from various protocols:
1. Ex-vivo brain slices with optogenetics: combine ABF recordings with optogenetic stimulus information.
2. Electrophysiology combined with optical imaging. Bruker optical sensor data with electrical recordings.
3. Two-photon laser scanning microscopy with electrical stimulation: process imaging data with stimulation events
4. Behavioral pharmacology: convert videos, tracking data, and drug administration metadata

The conversion of each protocol will handle the time alignment of data from each data stream.


# Data Organization - Raw data for Figs

## Figure 1

```
[256K]  .
├── [256K]  Dendritic excitability
│   ├── [256K]  LID off-state
│   ├── [256K]  LID on-state
│   └── [256K]  LID on-state with SCH
├── [256K]  Immunostaining images (Fig. 1B) confocal images
└── [256K]  Somatic excitability
    ├── [256K]  LID off-state
    ├── [256K]  LID on-state
    └── [256K]  LID on-state with SCH
```

### Somatic Excitability
It has a readme with the following info:

Read me:
Somatic excitability data were generated by recording voltage changes in response to current injection steps that are 500 ms in duration.
> Each folder with format “XXXXXXXX_X” represents data from a cell.
> Within the cell, “cell*-00*” represents a voltage recording trace.
> “cell*-001”: injection of -120pA current…
> “cell*-006”: injection of -20pA current…
> “cell*-007”: injection of 20pA current… and so forth.

15 directories on LID on-state

```
Command: 	 du -sh ./* | pbcopyfull
27M	./04112019_1
27M	./04122019_1
27M	./05012019_1
27M	./05032019_1
27M	./05072019_1
27M	./05072019_2
27M	./07062017_1
27M	./07062017_2
27M	./07072017_1
21M	./07072017_2
27M	./07192017_1
27M	./07192017_2
27M	./07202017_1
27M	./07202017_2
27M	./07212017_1
```

Let's look at one of them:

04112019_1
```
1,3M    ./cell1-001
1,3M    ./cell1-002
1,3M    ./cell1-003
1,3M    ./cell1-004
1,3M    ./cell1-005
1,3M    ./cell1-006
1,3M    ./cell1-007
1,3M    ./cell1-008
1,3M    ./cell1-009
1,3M    ./cell1-010
1,3M    ./cell1-011
1,3M    ./cell1-012
1,3M    ./cell1-013
1,3M    ./cell1-014
1,3M    ./cell1-015
1,3M    ./cell1-016
1,3M    ./cell1-017
1,3M    ./cell1-018
1,3M    ./cell1-019
1,3M    ./cell1-020
1,3M    ./cell1-021
```

And they look like this:

```
[256K]  .
├── [256K]  cell1-001
│   ├── [3.7K]  cell1-001_Cycle00001_VoltageOutput_001.xml
│   ├── [240K]  cell1-001_Cycle00001_VoltageRecording_001.csv
│   ├── [ 13K]  cell1-001_Cycle00001_VoltageRecording_001.xml
│   └── [ 554]  cell1-001.xml
├── [256K]  cell1-002
│   ├── [3.7K]  cell1-002_Cycle00001_VoltageOutput_001.xml
│   ├── [242K]  cell1-002_Cycle00001_VoltageRecording_001.csv
│   ├── [ 13K]  cell1-002_Cycle00001_VoltageRecording_001.xml
│   └── [ 554]  cell1-002.xml
├── [256K]  cell1-003
```

How do they look:

```xml
───────┬────────────────────────────────────────────────────────────────────────────────
       │ File: cell1-001.xml
───────┼────────────────────────────────────────────────────────────────────────────────
   1   │ <PVScan version="5.3.64.300" date="4/11/2019 3:17:18 PM" notes="">
   2   │   <Sequence type="VoltageRecording" cycle="1" time="15:17:18.1161356">
   3   │     <VoltageRecording name=" LIVE" triggerMode="None" cycle="1" index="1" confi
       │ gurationFile="cell1-001_Cycle00001_VoltageRecording_001.xml" dataFile="cell1-00
       │ 1_Cycle00001_VoltageRecording_001.csv" relativeTime="0" absoluteTime="0" />
   4   │     <VoltageOutput name="Step 1_-120 pA" triggerMode="None" filename="cell1-001
       │ _Cycle00001_VoltageOutput_001.xml" relativeTime="0" absoluteTime="0" />
   5   │   </Sequence>
   6   │ </PVScan>
```

- cell1-001_Cycle00001_VoltageOutput_001.xml
These is just a TimeSeries with two columns (time in ms) and Primary which from the xml should be in (mVThis is probably the )

- cell1-001_Cycle00001_VoltageRecording_001.xml
Most likely  XML describing how the raw data are acquired and scaled, which signals are recorded vs. disabled, and how the software’s user interface plots them.

- cell1-001_Cycle00001_VoltageOutput_001.xml

LID-off-state seems have the same structure.


### Dendritic Excitability
Missing a readme discussing the format but same top level structure as Somatic Excitability.

```bash
Command: 	 du -shc ./*
585M	./LID off-state
525M	./LID on-state
353M	./LID on-state with SCH
1,5G	total
```

LID on state

```bash
├── 0706a
│   ├── 0706a1
│   └── 0706a2
├── 0706b
│   └── 0706b1
├── 0707a
│   ├── 0707a1
│   └── 0707a2
├── 0707b
│   ├── 07072017_Cell2_dist2_trio-001
│   ├── 07072017_Cell2_dist2_trio-002
│   ├── 07072017_Cell2_dist2_trio-003
│   ├── 07072017_Cell2_prox2_trio-001
│   ├── 07072017_Cell2_prox2_trio-002
│   └── 07072017_Cell2_prox2_trio-003
├── 0719a
│   ├── 0719a1
│   └── 0719a2
├── 0719b
│   ├── 0719b1
│   └── 0719b2
├── 0720a
│   └── 0720a1
├── 0720b
│   ├── 0720b1
│   └── 0720b2
├── 0721a
│   ├── 0721a1
│   └── 0721a2
└── 0721b
    ├── 0721b1
    └── 0721b2
```
And the tree:


```
 heberto  …  LID on-state  0706a  0706a1  1  tree -shL 2
[256K]  .
├── [256K]  07062017_Cell1_dist1_trio-001
│   ├── [156K]  07062017_Cell1_dist1_trio-001_Cycle00001_Ch1_000001.ome.tif
│   ├── [ 33K]  07062017_Cell1_dist1_trio-001-Cycle00001_Ch1Source.tif
│   ├── [155K]  07062017_Cell1_dist1_trio-001_Cycle00001_Ch2_000001.ome.tif
│   ├── [ 33K]  07062017_Cell1_dist1_trio-001-Cycle00001_Ch2Source.tif
│   ├── [173K]  07062017_Cell1_dist1_trio-001_Cycle00001_LineProfileData.csv
│   ├── [5.4K]  07062017_Cell1_dist1_trio-001_Cycle00001_VoltageOutput_001.xml
│   ├── [997K]  07062017_Cell1_dist1_trio-001_Cycle00001_VoltageRecording_001.csv
│   ├── [ 13K]  07062017_Cell1_dist1_trio-001_Cycle00001_VoltageRecording_001.xml
│   ├── [286K]  07062017_Cell1_dist1_trio-001.env
│   ├── [6.4K]  07062017_Cell1_dist1_trio-001.xml
│   └── [256K]  References
├── [256K]  07062017_Cell1_dist1_trio-002
│   ├── [156K]  07062017_Cell1_dist1_trio-002_Cycle00001_Ch1_000001.ome.tif
│   ├── [ 33K]  07062017_Cell1_dist1_trio-002-Cycle00001_Ch1Source.tif
│   ├── [155K]  07062017_Cell1_dist1_trio-002_Cycle00001_Ch2_000001.ome.tif
│   ├── [ 33K]  07062017_Cell1_dist1_trio-002-Cycle00001_Ch2Source.tif
│   ├── [172K]  07062017_Cell1_dist1_trio-002_Cycle00001_LineProfileData.csv
│   ├── [5.4K]  07062017_Cell1_dist1_trio-002_Cycle00001_VoltageOutput_001.xml
│   ├── [996K]  07062017_Cell1_dist1_trio-002_Cycle00001_VoltageRecording_001.csv
│   ├── [ 13K]  07062017_Cell1_dist1_trio-002_Cycle00001_VoltageRecording_001.xml
│   ├── [286K]  07062017_Cell1_dist1_trio-002.env
│   ├── [6.4K]  07062017_Cell1_dist1_trio-002.xml
│   └── [256K]  References
```

There are tiffs here.

The references are also tiff fies

* Question: what are the references?

checking the metadata for one channel
```
  <Pixels DimensionOrder="XYZCT" ID="Pixels:1" PhysicalSizeX="0.194576" PhysicalSizeY="0.194576" PhysicalSizeZ="1" SizeC="2" SizeT="1" SizeX="31" SizeY="2500" SizeZ="1" Type="uint16">
```

Indicates that the tiffs at the bottom level of the tree are not time series. Images with two channels.

Question: what is ht

## Figure 2


## Figure 3

Very similar, also for dendritic experiments we have this at the bottom:

```bash
 05232016_Cell1_dist1_trio-001-Cycle00001_Ch1Source.tif              References
 05232016_Cell1_dist1_trio-001-Cycle00001_Ch2Source.tif
 05232016_Cell1_dist1_trio-001.env
 05232016_Cell1_dist1_trio-001.xml
 05232016_Cell1_dist1_trio-001_Cycle00001_Ch1_000001.ome.tif
 05232016_Cell1_dist1_trio-001_Cycle00001_Ch2_000001.ome.tif
 05232016_Cell1_dist1_trio-001_Cycle00001_LineProfileData.csv
 05232016_Cell1_dist1_trio-001_Cycle00001_VoltageOutput_001.xml
 05232016_Cell1_dist1_trio-001_Cycle00001_VoltageRecording_001.csv
 05232016_Cell1_dist1_trio-001_Cycle00001_VoltageRecording_001.xml
```

### Data Files

1. **Word File**: [Zhai et al. SA_manuscript_finalv2] - Most recent version of the submitted manuscript to Science Advances (adv8224) on 8 JAN 2025.
2. **PDF File**: [adv8224_SupplementalMaterial_v1] - Associated Supplemental Materials and Figures.
3. **Excel File**: [Key resources table_Zhai_v1] - Key resources table for relevant software (incl. Notebooks), protocols, antibodies, viruses, animals, chemicals, and hardware.
4. **Excel File**: [Data Connections] - Master sheets for raw data connections to panel figures, resources table, and some experiment metadata.
5. **Folder**: [Tabular dataset Zhai et al. 2025] - Includes readme file inside folder; spreadsheets for each Figure with separate pages for each Figure panel’s data.
6. **Folder**: [Raw data for Figs] - Folders arranged by Figure panels.


### Summary Information
### Submission Overview

The submission includes:
- 8 Figures
- 5 Supplemental Figures

### Primary Experiment Threads
1. **Somatic Excitability**:
    - AP number & rheobase
    - Electrophysiology

2. **Dendritic Excitability**:
    - Calcium imaging distal/proximal ratio along individual dendrites
    - Electrophysiology and 2P imaging

3. **Dendritic Spine Density**:
    - Morphology via 2P and confocal imaging

4. **Somatic EPSC Minis**:
    - Optical stimulation and electrophysiology

5. **LID AIM Behavior Scoring**

### Experimental Details
- **Non-behavior Experiments**:
  - Performed on a single Bruker Ultima 2P system (S/N 4503) running Prairie View 5.x software
  - Uses three different A-to-D cards to synchronize recorded images with protocol-defined experimental input and output voltages
  - System configurations for dendritic excitability, somatic EPSC minis, and ACh BOT imaging from Fig 5 create .csv files during acquisition
  - All instrument system setting metadata is included in the Prairie View raw data folders

- **Confocal Spine Density Images**:
  - Acquired on a Core Facility Nikon A1R confocal system

- **AIM Behavior Scoring**:
  - Scored manually in real-time by Dr. Zhai
  - Videos provide potential refinement for later review

### Brain Slice Regions
- **Spiny Projection Neurons**:
  - Direct, D1: Figs 1 & 2, td-tomato
  - Indirect, D2: Figs 3 & 4, 6-8, eGFP

### Main Animal Manipulations
- **6-OHDA (PD) Lesioning**
- **LevaDopa Treatments**:
  - Different delays (LID OFF, ON)


#### Figure 1 Someiatc Excitability Readme
Somatic excitability data were generated by recording voltage changes in response to current injection steps that are 500 ms in duration.

Each folder with format “XXXXXXXX_X” represents data from a cell.
Within the cell, “cell*-00*” represents a voltage recording trace.
“cell*-001”: injection of -120pA current…
“cell*-006”: injection of -20pA current…
“cell*-007”: injection of 20pA current… and so forth.


### Data Connections
| TECHNIQUE                   | FIG     | CONT      | PD        | LID OFF   | LID OFF  | LID ON    | ON + agon | OXO     | OXO     | MSN    | MOUSE           | Age     | Virus Inj  | Ldopa   | Slicing | Patching  | Imaging  | Stimulation                     | Analysis               | Analysis        | Analysis       | Analysis       | Analysis         |
|-----------------------------|---------|-----------|-----------|-----------|----------|-----------|-----------|---------|---------|--------|----------------|---------|------------|---------|---------|-----------|----------|--------------------------------|------------------------|----------------|---------------|---------------|-----------------|
| Somatic Excitability        | 1F      | -         | -         | 15(8)8    | -        | 15(10)10  | 10(5)5    | -       | -       | D1     | tdTomato       | 7-12 wks | -          | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | pA separate traces       | 14145776       | RMP [5, 195]ms | [200, 700]ms   | #APs in 0.5s     |
| Somatic Excitability        | 3D      | -         | -         | 12(5)5    | -        | 11(8)8    | 7(4)4     | -       | -       | D2     | eGFP           | 7-12 wks | -          | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | -                      | 14145776       | Not shown       | -               | #APs in 0.5s     |
| VEHICLE CONTROL FOR FIG6    | 6C      | 8(4)4     | -         | 12(5)5    | 10(5)5   | -         | -         | -       | -       | D2     | eGFP           | 7-12 wks | M1R ant    | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | -                      | 14145776       | -               | -               | #APs in 0.5s     |
| VEHICLE CONTROL FOR FIG6    | 7C      | -         | -         | 13(5)5    | -        | 8(4)4     | -         | -       | -       | D2     | CDGIko X eGFP  | ~8 wks   | -          | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | -                      | 14145776       | -               | -               | #APs in 0.5s     |
| VEHICLE CONTROL FOR FIG8    | 8D      | 6(3)2     | -         | -         | -        | 8(4)3     | -         | -       | -       | D2     | Adora2-Cre     | ~8 wks   | 3 viruses  | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | -                      | 14145776       | -               | -               | #APs in 0.5s     |
| VEHICLE CONTROL FOR FIG8    | SF4     | -         | -         | -         | -        | -         | 7(3)3     | 6(3)3   | -       | D2     | Adora2-Cre     | ~8 wks   | 3 viruses  | -       | I Clamp | 2P GEI    | Neg120 to 300pA, 0.5s | -                      | 14145776       | -               | -               | #APs in 0.5s     |
| Dendritic Excitability      | 1I      | -         | -         | 10(7)7    | -        | 10(5)5    | 9(9)5     | -       | -       | D1     | tdTomato       | 7-12 wks | -          | -       | I Clamp | 2P Fluo-4 | 2nA, 2ms X3 @50Hz      | 4r3I294nqv1y/v1        | 14163502       | F0 [0.5, 0.95]s | F [1.0, 1.5]s  | (G-G0)/G0R0 AUC  |
| Dendritic Excitability      | 3F      | -         | -         | 10(5)5    | -        | 10(5)5    | 8(6)6     | -       | -       | D2     | eGFP           | 7-12 wks | -          | -       | I Clamp | 2P Fluo-4 | 2nA, 2ms X3 @50Hz      | 4r3I294nqv1y/v1        | 14163502       | Dist/Prox        | Same dendrite   | (G-G0)/G0R0 AUC  |
| ADD 25 apr 24, REM PT 25 FEB 20 | 6D  | 9(5)5     | -         | -         | -        | 7(4)4     | -         | -       | -       | D2     | eGFP           | 7-12 wks | M1R ant    | -       | I Clamp | 2P Fluo-4 | 2nA, 2ms X3 @50Hz      | 4r3I294nqv1y/v1        | 14163502       | G0/R0 ratio      | -               | (G-G0)/G0R0 AUC  |
| Spine Density               | 2BC     | 10(6)6    | 11(5)5    | 13(8)8    | -        | 8(5)5     | 10d, 11p  | -       | -       | D1     | tdTomato       | 7-12 wks | -          | -       | V Clamp | 2P Alexa  | Fluor feature morph   | Autoquant               | -              | -               | -               | #spines/um       |
| Presynaptic Excitability    | 2H      | SF1A      | -         | 10(4)3    | -        | 8(4)4     | -         | -       | -       | D1     | tdTomato       | 7-12 wks | ChR2-eYFP  | -       | V Clamp | 2P GEI    | ?%, 0.3ms (LED), 10 runs | 5qpvokx914o/v1        | TaroTools      | V0 [0, 20]ms   | 40 to 400ms     | EPSCs >5 stdev   |
| Ach Dynamics (BOT)          | 5F      | SF2       | 13/7(3)3  | 10/6(3)3  | 11/11(5)5 | -         | -         | -       | -       | D1 & D2 | C57bl/6J       | ~8 wks   | ACh3.0     | -       | 2P GEI  | 0.3mA, 1ms (electrode) | 21fps                    | 14163731       | F0 [9,10]s      | F[10,12]s       | (G-G0)/G0 AUC    |
| AIM Score                   | 7I [7J] | SF3A      | (8) [10]  | -         | -        | (9) [11]  | -         | -       | -       | D2     | CDGIko X eGFP  | ~8 wks   | -          | -       | -       | -         | -                             | 5jy18dm8rg2w/v1        | Spreadsheet    | -               | -               | AIM scores       |

## Working comments:

How to look for files:
```bash
find . -type f \( -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o -iname "*.mkv" \)
```
```bash
ls -R | rg ".MP4"
```

## First Email:

  Hi, everyone

  I reviewed the data that has been transferred so far and here is what we are missing in terms of the scope of work that we agreed on. We have now imaging voltage and Line profiles from the Bruker systems corresponding to figures 1 and 3.

  Going from the organizations that that the team of the Dr Surmeier has provided we are missing data from the following figures: 2, 4, 5, 6, 7 and 8.

  Going from the Scope of Work we are missing data for the following streams:
  - Bruker optical sensor recordings with appropriate metadata
  - ABFs from Axon
  - Behavioral video recordings
  - Electrical stimulation signals and metadata
  - Manual segmentation data for ROIs.

  Feel free to set up a meeting so we can check together why there might be a bottleneck



* tiff imaging files for the experiments described on figures 1 and 3.
* LineProfile data from Bruker that I think corresponds to the Fluoresence traces
